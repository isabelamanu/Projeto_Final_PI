# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: CI/CD - Qualidade, Testes e Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci_pipeline:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.10", "3.12"]

    steps:
    - name: 1. Checkout do Código
      uses: actions/checkout@v4

    - name: 2. Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: 3. Instalar Dependências (Incluindo Pacote e Testes)
      run: |
        python -m pip install --upgrade pip
        # Instala o projeto em modo editável e todas as dependências de teste
        pip install -e .[test] 
        # Instala as ferramentas de qualidade
        pip install black flake8

    - name: 4. Rodar Black (Formatação)
      run: black --check .

    - name: 5. Rodar Flake8 (Qualidade/Lint)
      run: flake8 . 

    - name: 6. Executa Testes (Pytest)
      run: pytest --cov=.

  deploy:
    needs: ci_pipeline
    runs-on: ubuntu-latest
    
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: 1. Checkout do Código
      uses: actions/checkout@v4

    - name: 2. Configurar Python 3.12 (Versão estável para deploy)
      uses: actions/setup-python@v5
      with:
        python-version: 3.12
        
    - name: 3. Instalar Dependências de Build e Upload
      run: |
        python -m pip install --upgrade pip
        # Instala o pacote build e twine
        pip install build twine 

    - name: 4. Construir Pacote (python -m build)
      run: python -m build

    - name: 5. Publicar no PyPI (Twine Upload)
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}